name: Deploy to Self-Hosted Server (Direct Host Execution)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

env:
  # Facebook Service Test Environment
  FACEBOOK_ACCESS_TOKEN: test_token_for_deploy_pipeline
  FACEBOOK_API_VERSION: v18.0
  # Application Configuration
  FLASK_PORT: 5000
  NODE_PORT: 3000
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: self-hosted
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: Pre-checkout permission and process cleanup
      run: |
        echo "ğŸ”§ Pre-checkout cleanup for direct host execution..."
        
        # Stop any running Flask/Node processes from previous deployments
        pkill -f "python.*app.py" 2>/dev/null || true
        pkill -f "flask.*run" 2>/dev/null || true
        pkill -f "node.*remotion" 2>/dev/null || true
        pkill -f "npm.*start" 2>/dev/null || true
        
        # Fix workspace permissions
        sudo chown -R $USER:$USER ${{ github.workspace }} 2>/dev/null || true
        sudo chmod -R 755 ${{ github.workspace }} 2>/dev/null || true
        
        # Clean up application directories
        sudo rm -rf ${{ github.workspace }}/public/audios ${{ github.workspace }}/public/models 2>/dev/null || true
        sudo rm -rf ${{ github.workspace }}/emlinh_mng/instance 2>/dev/null || true
        sudo rm -rf ${{ github.workspace }}/emlinh-remotion/out ${{ github.workspace }}/emlinh-remotion/public/audios 2>/dev/null || true
        
        echo "âœ… Pre-checkout cleanup completed"
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        clean: false
        
    - name: Post-checkout directory setup
      run: |
        echo "ğŸ“ Setting up directories for direct host execution..."
        mkdir -p public/audios public/models emlinh_mng/instance
        mkdir -p emlinh-remotion/out emlinh-remotion/public/audios
        chmod -R 755 public/ emlinh_mng/instance/ emlinh-remotion/out/ emlinh-remotion/public/audios/ 2>/dev/null || true
        echo "âœ… Directory setup completed"

    - name: Set up Python environment
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: emlinh-remotion/package-lock.json

    - name: Install Python dependencies
      run: |
        echo "ğŸ Installing Python dependencies for direct execution..."
        cd emlinh_mng
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Python dependencies installed"

    - name: Install Node.js dependencies
      run: |
        echo "ğŸ“¦ Installing Node.js dependencies for direct execution..."
        cd emlinh-remotion
        npm ci || {
          echo "âš ï¸ npm ci failed, trying npm install..."
          npm install
        }
        echo "âœ… Node.js dependencies installed"

    - name: Run Python tests
      run: |
        echo "ğŸ§ª Running Python tests on host environment..."
        cd emlinh_mng
        export PYTHONPATH=src:$PYTHONPATH
        python -m pytest src/tests/ -v || true
        echo "âœ… Python tests completed"

    - name: ğŸ§ª Run Facebook Service Tests
      run: |
        echo "ğŸ” Running Facebook Service tests on host environment..."
        cd emlinh_mng
        export PYTHONPATH=src:$PYTHONPATH
        
        # Run Simple Tests
        python src/tests/test_facebook_service_simple.py
        echo "âœ… Simple tests passed"
        
        # Run Complete Tests
        python src/tests/test_facebook_complete.py
        echo "âœ… Complete tests passed"
        
        # Test imports
        python -c "import sys; sys.path.insert(0, 'src/services'); from facebook_service import FacebookService; print('âœ… Facebook Service imports successful')"
        
        # Test configuration
        python -c "import sys; sys.path.insert(0, 'src'); from app.config import Config; print('âœ… Configuration verified')"
        
        echo "ğŸ‰ All Facebook Service tests completed successfully!"

    - name: Run Node.js tests and validation
      run: |
        echo "ğŸ” Running Node.js validation on host environment..."
        cd emlinh-remotion
        npm run lint || echo "âš ï¸ Lint warnings (non-blocking)"
        
        # Test Remotion CLI availability
        npx remotion --version || echo "âš ï¸ Remotion CLI test warning (non-blocking)"
        
        echo "âœ… Node.js validation completed"

    - name: Test Flask app startup
      run: |
        echo "ğŸŒ¶ï¸ Testing Flask application startup..."
        cd emlinh_mng
        # Create test environment file
        cat > .env.test << 'EOF'
        SECRET_KEY=test_key_for_startup_check
        DATABASE_URL=sqlite:///test.db
        FLASK_ENV=development
        OLLAMA_BASE_URL=http://localhost:11434
        OLLAMA_EMBED_MODEL=nomic-embed-text
        EMBEDDING_DIMENSION=768
        FACEBOOK_ACCESS_TOKEN=test_token
        FACEBOOK_API_VERSION=v18.0
        SQLALCHEMY_ECHO=False
        EOF
        
        # Test app import and basic startup
        timeout 30 python -c "import sys; sys.path.insert(0, 'src'); from app.app import create_app; app = create_app(); print('âœ… Flask app can be created successfully')" || echo "âš ï¸ Flask startup test completed with warnings"
        
        rm -f .env.test test.db
        echo "âœ… Flask application startup test completed"

  deploy:
    runs-on: self-hosted
    needs: test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')
    
    steps:
    - name: Pre-deployment cleanup
      run: |
        echo "ğŸ”§ Pre-deployment cleanup for direct host execution..."
        
        # Stop any existing application processes
        pkill -f "python.*app.py" 2>/dev/null || true
        pkill -f "flask.*run" 2>/dev/null || true
        pkill -f "node.*remotion" 2>/dev/null || true
        pkill -f "npm.*start" 2>/dev/null || true
        pkill -f "gunicorn" 2>/dev/null || true
        
        # Wait for processes to stop
        sleep 5
        
        # Fix workspace permissions
        sudo chown -R $USER:$USER ${{ github.workspace }} 2>/dev/null || true
        sudo chmod -R 755 ${{ github.workspace }} 2>/dev/null || true
        
        # Clean up application directories
        sudo rm -rf ${{ github.workspace }}/public/audios ${{ github.workspace }}/public/models 2>/dev/null || true
        sudo rm -rf ${{ github.workspace }}/emlinh_mng/instance 2>/dev/null || true
        sudo rm -rf ${{ github.workspace }}/emlinh-remotion/out ${{ github.workspace }}/emlinh-remotion/public/audios 2>/dev/null || true
        
        echo "âœ… Pre-deployment cleanup completed"
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        clean: false

    - name: Set up Python environment for deployment
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js environment for deployment
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Create production environment file
      run: |
        echo "ğŸ”§ Creating production environment configuration..."
        cat > .env << 'EOF'
        # Core application settings
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        FLASK_ENV=production
        
        # Host execution configuration (no Docker)
        WORKSPACE_ROOT=${{ github.workspace }}
        HOST_EXECUTION=true
        
        # Application ports for direct host execution
        FLASK_PORT=5000
        NODE_PORT=3000
        
        # AI/ML services
        OLLAMA_BASE_URL=${{ secrets.OLLAMA_BASE_URL }}
        OLLAMA_EMBED_MODEL=${{ secrets.OLLAMA_EMBED_MODEL || 'nomic-embed-text' }}
        EMBEDDING_DIMENSION=${{ secrets.EMBEDDING_DIMENSION || '768' }}
        
        # OpenAI API
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        
        # Facebook API (Issue #13)
        FACEBOOK_ACCESS_TOKEN=${{ secrets.FACEBOOK_ACCESS_TOKEN }}
        FACEBOOK_API_VERSION=v18.0
        
        # SQLAlchemy settings
        SQLALCHEMY_ECHO=${{ secrets.SQLALCHEMY_ECHO || 'False' }}
        EOF
        echo "âœ… Production environment file created"

    - name: Create necessary directories for host execution
      run: |
        echo "ğŸ“ Creating directories for direct host execution..."
        mkdir -p public/audios public/models ssl
        mkdir -p emlinh_mng/instance
        mkdir -p emlinh-remotion/out emlinh-remotion/public/audios
        chmod -R 755 public/ emlinh_mng/instance/ emlinh-remotion/out/ emlinh-remotion/public/audios/
        echo "âœ… Directories created with proper permissions"

    - name: Copy environment file to Flask app directory
      run: |
        cp .env emlinh_mng/.env
        echo "âœ… Environment file copied to Flask application"

    - name: Validate environment and workspace setup
      run: |
        echo "ğŸ” Validating environment setup for direct host execution..."
        echo "WORKSPACE_ROOT: ${{ github.workspace }}"
        echo "Current directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        
        # Validate required directories exist
        if [ ! -d "emlinh_mng" ]; then
          echo "âŒ emlinh_mng directory not found"
          exit 1
        fi
        
        if [ ! -d "emlinh-remotion" ]; then
          echo "âŒ emlinh-remotion directory not found"
          exit 1
        fi
        
        # Check if .env files exist
        if [ ! -f ".env" ]; then
          echo "âŒ Root .env file not found"
          exit 1
        fi
        
        if [ ! -f "emlinh_mng/.env" ]; then
          echo "âŒ Flask app .env file not found"
          exit 1
        fi
        
        echo "âœ… Environment validation passed"

    - name: Install production Python dependencies
      run: |
        echo "ğŸ Installing Python dependencies for production on host..."
        cd emlinh_mng
        
        # Create virtual environment with system Python
        rm -rf venv 2>/dev/null || true
        python3 -m venv venv --system-site-packages
        
        # Activate and install dependencies with error checking
        source venv/bin/activate
        
        echo "ğŸ“¦ Upgrading pip..."
        python -m pip install --upgrade pip || {
          echo "âŒ Failed to upgrade pip"
          exit 1
        }
        
        echo "ğŸ“¦ Installing requirements.txt..."
        pip install -r requirements.txt || {
          echo "âŒ Failed to install requirements.txt"
          cat requirements.txt
          exit 1
        }
        
        echo "ğŸ“¦ Installing gunicorn..."
        pip install gunicorn || {
          echo "âŒ Failed to install gunicorn"
          exit 1
        }
        
        echo "ğŸ” Verifying installations..."
        python -c "import flask; print(f'âœ… Flask version: {flask.__version__}')" || {
          echo "âŒ Flask import failed"
          exit 1
        }
        
        python -c "import gunicorn; print(f'âœ… Gunicorn version: {gunicorn.__version__}')" || {
          echo "âŒ Gunicorn import failed"
          exit 1
        }
        
        which gunicorn && echo "âœ… Gunicorn executable found at: $(which gunicorn)"
        
        python -c "from wsgi import application; print('âœ… WSGI import successful')" || {
          echo "âŒ WSGI import failed"
          exit 1
        }
        
        echo "âœ… All Python dependencies installed and verified successfully"

    - name: Setup Remotion for production on host
      run: |
        echo "ğŸ¬ Setting up Remotion for production on host..."
        cd emlinh-remotion
        
        # Install dependencies
        npm install || {
          echo "âš ï¸ npm install failed, trying alternative methods..."
          npm ci || npm install --legacy-peer-deps || true
        }
        
        # Test Remotion CLI with timeout (non-blocking)
        echo "ğŸ¬ Testing Remotion CLI for direct host execution..."
        timeout 30 npx remotion --version 2>/dev/null && {
          echo "âœ… Remotion CLI working on host"
        } || {
          echo "âš ï¸ Remotion CLI test failed or timed out"
          echo "   Application will use fallback mechanisms"
        }
        
        echo "âœ… Remotion setup completed for host execution"

    - name: Stop existing application processes
      run: |
        echo "ğŸ›‘ Stopping existing application processes..."
        pkill -f "python.*app.py" 2>/dev/null || true
        pkill -f "flask.*run" 2>/dev/null || true
        pkill -f "gunicorn" 2>/dev/null || true
        pkill -f "node.*remotion" 2>/dev/null || true
        pkill -f "npm.*start" 2>/dev/null || true
        sleep 5
        echo "âœ… Existing processes stopped"

    - name: Test Flask application before starting Gunicorn
      run: |
        echo "ğŸ§ª Testing Flask application before production startup..."
        cd emlinh_mng
        
        # Activate virtual environment
        source venv/bin/activate
        
        # Test WSGI import
        echo "ğŸ” Testing WSGI import..."
        python -c "
        import sys
        sys.path.insert(0, 'src')
        try:
            from wsgi import application
            print('âœ… WSGI import successful')
        except Exception as e:
            print(f'âŒ WSGI import failed: {e}')
            exit(1)
        "
        
        # Test Flask app creation
        echo "ğŸ” Testing Flask app creation..."
        python -c "
        import sys
        sys.path.insert(0, 'src')
        try:
            from app.app import create_app
            app, socketio = create_app()
            print('âœ… Flask app creation successful')
            print(f'âœ… App config: {app.config.get(\"FLASK_ENV\", \"default\")}')
        except Exception as e:
            print(f'âŒ Flask app creation failed: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
        
        # Test database connection
        echo "ğŸ” Testing database connection..."
        python -c "
        import sys
        sys.path.insert(0, 'src')
        try:
            from app.app import create_app
            from app.extensions import db
            app, socketio = create_app()
            with app.app_context():
                db.create_all()
                print('âœ… Database connection and initialization successful')
        except Exception as e:
            print(f'âŒ Database test failed: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
        
        echo "âœ… All Flask application tests passed"

    - name: Start Flask application on host
      run: |
        echo "ğŸŒ¶ï¸ Starting Flask application directly on host with enhanced error handling..."
        cd emlinh_mng
        
        # Activate virtual environment
        source venv/bin/activate
        
        # Create enhanced gunicorn configuration
        cat > gunicorn.conf.py << 'EOF'
        import multiprocessing
        import os

        # Server socket
        bind = "0.0.0.0:5000"
        backlog = 2048

        # Worker processes
        workers = 2
        worker_class = "sync"
        worker_connections = 1000
        timeout = 60
        keepalive = 30
        max_requests = 1000
        max_requests_jitter = 50

        # Restart workers after this many requests, to help prevent memory leaks
        preload_app = True

        # Logging
        accesslog = "access.log"
        errorlog = "error.log"
        loglevel = "info"
        access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s"'

        # Process naming
        proc_name = "emlinh_flask_app"

        # Server mechanics
        pidfile = "gunicorn.pid"
        user = None
        group = None
        tmp_upload_dir = None

        # SSL
        keyfile = None
        certfile = None
        EOF
        
        # Test gunicorn configuration
        echo "ğŸ” Testing Gunicorn configuration..."
        gunicorn --check-config -c gunicorn.conf.py wsgi:application || {
          echo "âŒ Gunicorn configuration test failed"
          exit 1
        }
        
        # Start Flask app with enhanced Gunicorn configuration
        echo "ğŸš€ Starting Gunicorn with enhanced configuration..."
        nohup gunicorn -c gunicorn.conf.py wsgi:application > flask.log 2>&1 &
        
        # Store Flask PID for later management
        echo $! > ../flask.pid
        
        echo "âœ… Flask application started on host (PID: $(cat ../flask.pid))"
        
        # Wait a moment and check if process is still running
        sleep 5
        if kill -0 $(cat ../flask.pid) 2>/dev/null; then
          echo "âœ… Flask process is still running after startup check"
        else
          echo "âŒ Flask process died shortly after startup"
          echo "ğŸ“‹ Last 30 lines of flask.log:"
          tail -30 flask.log || true
          echo ""
          echo "ğŸ“‹ Last 30 lines of error.log:"
          tail -30 error.log || true
          echo ""
          echo "ğŸ“‹ Checking for gunicorn processes:"
          ps aux | grep gunicorn || true
          echo ""
          echo "ğŸ“‹ Checking port 5000:"
          netstat -tulpn | grep 5000 || true
          echo ""
          echo "ğŸ“‹ System logs related to Python/Gunicorn:"
          journalctl -u "*python*" -u "*gunicorn*" --no-pager -n 20 || true
          exit 1
        fi

    - name: Wait for Flask application to be ready
      run: |
        echo "â³ Waiting for Flask application to be ready..."
        
        # Enhanced health check with better debugging
        attempts=0
        max_attempts=24  # 24 attempts * 5 seconds = 2 minutes
        
        while [ $attempts -lt $max_attempts ]; do
          echo "ğŸ” Health check attempt $((attempts + 1))/$max_attempts..."
          
          # Check if process is still running
          if [ -f "flask.pid" ] && kill -0 $(cat flask.pid) 2>/dev/null; then
            echo "âœ… Flask process is running (PID: $(cat flask.pid))"
            
            # Try health check
            if curl -f -s http://localhost:${{ env.FLASK_PORT }}/health >/dev/null 2>&1; then
              echo "âœ… Flask application is ready and responding to health checks!"
              break
            else
              echo "âš ï¸ Flask process running but not responding to health check yet..."
              
              # Show recent logs for debugging
              if [ $((attempts % 4)) -eq 0 ]; then
                echo "ğŸ“‹ Recent logs (last 10 lines):"
                tail -10 emlinh_mng/flask.log 2>/dev/null || echo "No flask.log found"
                echo "ğŸ“‹ Recent error logs (last 5 lines):"
                tail -5 emlinh_mng/error.log 2>/dev/null || echo "No error.log found"
              fi
            fi
          else
            echo "âŒ Flask process is not running!"
            echo "ğŸ“‹ Full flask.log:"
            cat emlinh_mng/flask.log 2>/dev/null || echo "No flask.log found"
            echo "ğŸ“‹ Full error.log:"
            cat emlinh_mng/error.log 2>/dev/null || echo "No error.log found"
            exit 1
          fi
          
          attempts=$((attempts + 1))
          sleep 5
        done
        
        # Final check
        if [ $attempts -eq $max_attempts ]; then
          echo "âŒ Flask application failed to start properly after $max_attempts attempts"
          echo ""
          echo "ğŸ“‹ Final diagnostic information:"
          echo "Process status:"
          if [ -f "flask.pid" ]; then
            if kill -0 $(cat flask.pid) 2>/dev/null; then
              echo "  âœ… Process is running (PID: $(cat flask.pid))"
            else
              echo "  âŒ Process is not running"
            fi
          else
            echo "  âŒ PID file not found"
          fi
          
          echo ""
          echo "Port status:"
          netstat -tulpn | grep 5000 || echo "  âŒ No process listening on port 5000"
          
          echo ""
          echo "Last 30 lines of flask.log:"
          tail -30 emlinh_mng/flask.log 2>/dev/null || echo "  âŒ No flask.log found"
          
          echo ""
          echo "Last 30 lines of error.log:"
          tail -30 emlinh_mng/error.log 2>/dev/null || echo "  âŒ No error.log found"
          
          echo ""
          echo "Gunicorn processes:"
          ps aux | grep gunicorn || echo "  âŒ No gunicorn processes found"
          
          exit 1
        fi

    - name: Verify deployment health
      run: |
        echo "ğŸ” Verifying deployment health..."
        
        # Check Flask app health
        curl -f http://localhost:${{ env.FLASK_PORT }}/health || {
          echo "âŒ Flask health check failed"
          exit 1
        }
        
        # Check if Flask process is running
        if [ -f "flask.pid" ] && kill -0 $(cat flask.pid) 2>/dev/null; then
          echo "âœ… Flask process is running (PID: $(cat flask.pid))"
        else
          echo "âŒ Flask process is not running"
          exit 1
        fi
        
        # Test basic API endpoints
        curl -f http://localhost:${{ env.FLASK_PORT }}/ >/dev/null || {
          echo "âš ï¸ Root endpoint test failed"
        }
        
        echo "âœ… Deployment health verification passed!"

    - name: Create application management scripts
      run: |
        echo "ğŸ“œ Creating application management scripts for host execution..."
        
        # Create enhanced start script
        echo '#!/bin/bash' > start_app.sh
        echo 'echo "ğŸš€ Starting EmLinh applications on host..."' >> start_app.sh
        echo 'echo "ğŸ“… Start time: $(date)"' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Pre-flight checks' >> start_app.sh
        echo 'echo "ğŸ” Running pre-flight checks..."' >> start_app.sh
        echo 'cd emlinh_mng' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Check virtual environment' >> start_app.sh
        echo 'if [ ! -d "venv" ]; then' >> start_app.sh
        echo '  echo "âŒ Virtual environment not found"' >> start_app.sh
        echo '  exit 1' >> start_app.sh
        echo 'fi' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Activate virtual environment' >> start_app.sh
        echo 'source venv/bin/activate' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Test WSGI import' >> start_app.sh
        echo 'echo "ğŸ” Testing WSGI import..."' >> start_app.sh
        echo 'python -c "import sys; sys.path.insert(0, '\''src'\''); from wsgi import application; print('\''âœ… WSGI import successful'\'')" || {' >> start_app.sh
        echo '  echo "âŒ WSGI import failed"' >> start_app.sh
        echo '  exit 1' >> start_app.sh
        echo '}' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Stop any existing processes' >> start_app.sh
        echo 'echo "ğŸ›‘ Stopping existing processes..."' >> start_app.sh
        echo 'pkill -f "gunicorn" 2>/dev/null || true' >> start_app.sh
        echo 'sleep 2' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Start Gunicorn with enhanced configuration' >> start_app.sh
        echo 'echo "ğŸš€ Starting Gunicorn..."' >> start_app.sh
        echo 'if [ -f "gunicorn.conf.py" ]; then' >> start_app.sh
        echo '  nohup gunicorn -c gunicorn.conf.py wsgi:application > flask.log 2>&1 &' >> start_app.sh
        echo 'else' >> start_app.sh
        echo '  nohup gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 60 --log-level info wsgi:application > flask.log 2>&1 &' >> start_app.sh
        echo 'fi' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Store Flask PID' >> start_app.sh
        echo 'echo $! > ../flask.pid' >> start_app.sh
        echo 'echo "âœ… Flask app started (PID: $(cat ../flask.pid))"' >> start_app.sh
        echo '' >> start_app.sh
        echo '# Wait and verify startup' >> start_app.sh
        echo 'echo "â³ Waiting for app to be ready..."' >> start_app.sh
        echo 'sleep 5' >> start_app.sh
        echo '' >> start_app.sh
        echo 'if kill -0 $(cat ../flask.pid) 2>/dev/null; then' >> start_app.sh
        echo '  echo "âœ… Process is running"' >> start_app.sh
        echo '  ' >> start_app.sh
        echo '  # Test health endpoint' >> start_app.sh
        echo '  for i in {1..12}; do' >> start_app.sh
        echo '    if curl -f -s http://localhost:5000/health >/dev/null 2>&1; then' >> start_app.sh
        echo '      echo "âœ… Health check passed"' >> start_app.sh
        echo '      echo "ğŸ‰ Applications started successfully!"' >> start_app.sh
        echo '      echo "ğŸ”— App URL: http://localhost:5000"' >> start_app.sh
        echo '      exit 0' >> start_app.sh
        echo '    fi' >> start_app.sh
        echo '    echo "â³ Waiting for health check... ($i/12)"' >> start_app.sh
        echo '    sleep 5' >> start_app.sh
        echo '  done' >> start_app.sh
        echo '  ' >> start_app.sh
        echo '  echo "âš ï¸ App started but health check failed"' >> start_app.sh
        echo '  echo "ğŸ“‹ Recent logs:"' >> start_app.sh
        echo '  tail -10 flask.log' >> start_app.sh
        echo 'else' >> start_app.sh
        echo '  echo "âŒ Process died after startup"' >> start_app.sh
        echo '  echo "ğŸ“‹ Logs:"' >> start_app.sh
        echo '  cat flask.log' >> start_app.sh
        echo '  exit 1' >> start_app.sh
        echo 'fi' >> start_app.sh
        
        # Create stop script
        echo '#!/bin/bash' > stop_app.sh
        echo 'echo "ğŸ›‘ Stopping EmLinh applications..."' >> stop_app.sh
        echo 'if [ -f "flask.pid" ]; then' >> stop_app.sh
        echo '  kill $(cat flask.pid) 2>/dev/null || true' >> stop_app.sh
        echo '  rm -f flask.pid' >> stop_app.sh
        echo '  echo "âœ… Flask app stopped"' >> stop_app.sh
        echo 'fi' >> stop_app.sh
        echo 'pkill -f "gunicorn" 2>/dev/null || true' >> stop_app.sh
        echo 'pkill -f "python.*app.py" 2>/dev/null || true' >> stop_app.sh
        echo 'echo "âœ… All applications stopped"' >> stop_app.sh
        
        # Create enhanced status script
        echo '#!/bin/bash' > status_app.sh
        echo 'echo "ğŸ“Š === APPLICATION STATUS === ğŸ“Š"' >> status_app.sh
        echo 'echo "ğŸ“… Check time: $(date)"' >> status_app.sh
        echo 'echo ""' >> status_app.sh
        echo '' >> status_app.sh
        echo '# Check Flask process' >> status_app.sh
        echo 'echo "ğŸ” Flask Application Status:"' >> status_app.sh
        echo 'if [ -f "flask.pid" ]; then' >> status_app.sh
        echo '  PID=$(cat flask.pid)' >> status_app.sh
        echo '  if kill -0 $PID 2>/dev/null; then' >> status_app.sh
        echo '    echo "  âœ… Flask app is running (PID: $PID)"' >> status_app.sh
        echo '    echo "  ğŸ“‹ Process details:"' >> status_app.sh
        echo '    ps aux | grep $PID | grep -v grep' >> status_app.sh
        echo '  else' >> status_app.sh
        echo '    echo "  âŒ Flask app is not running (PID file exists but process dead)"' >> status_app.sh
        echo '  fi' >> status_app.sh
        echo 'else' >> status_app.sh
        echo '  echo "  âŒ Flask app is not running (no PID file)"' >> status_app.sh
        echo 'fi' >> status_app.sh
        echo 'echo ""' >> status_app.sh
        echo '' >> status_app.sh
        echo '# Check Gunicorn processes' >> status_app.sh
        echo 'echo "ğŸ” Gunicorn Processes:"' >> status_app.sh
        echo 'GUNICORN_COUNT=$(pgrep -f gunicorn | wc -l)' >> status_app.sh
        echo 'if [ $GUNICORN_COUNT -gt 0 ]; then' >> status_app.sh
        echo '  echo "  âœ… Found $GUNICORN_COUNT Gunicorn processes"' >> status_app.sh
        echo '  ps aux | grep gunicorn | grep -v grep' >> status_app.sh
        echo 'else' >> status_app.sh
        echo '  echo "  âŒ No Gunicorn processes found"' >> status_app.sh
        echo 'fi' >> status_app.sh
        echo 'echo ""' >> status_app.sh
        echo '' >> status_app.sh
        echo '# Check port 5000' >> status_app.sh
        echo 'echo "ğŸ” Port 5000 Status:"' >> status_app.sh
        echo 'if netstat -tulpn | grep ":5000 " >/dev/null; then' >> status_app.sh
        echo '  echo "  âœ… Port 5000 is in use"' >> status_app.sh
        echo '  netstat -tulpn | grep ":5000 "' >> status_app.sh
        echo 'else' >> status_app.sh
        echo '  echo "  âŒ Port 5000 is not in use"' >> status_app.sh
        echo 'fi' >> status_app.sh
        echo 'echo ""' >> status_app.sh
        echo '' >> status_app.sh
        echo '# Health check' >> status_app.sh
        echo 'echo "ğŸ” Health Check:"' >> status_app.sh
        echo 'if curl -f -s http://localhost:5000/health >/dev/null 2>&1; then' >> status_app.sh
        echo '  echo "  âœ… Health check passed"' >> status_app.sh
        echo '  echo "  ğŸ“‹ Health response:"' >> status_app.sh
        echo '  curl -s http://localhost:5000/health | jq . 2>/dev/null || curl -s http://localhost:5000/health' >> status_app.sh
        echo 'else' >> status_app.sh
        echo '  echo "  âŒ Health check failed"' >> status_app.sh
        echo '  echo "  ğŸ“‹ curl details:"' >> status_app.sh
        echo '  curl -v http://localhost:5000/health 2>&1 | head -10' >> status_app.sh
        echo 'fi' >> status_app.sh
        echo 'echo ""' >> status_app.sh
        echo '' >> status_app.sh
        echo '# Check logs' >> status_app.sh
        echo 'echo "ğŸ” Recent Logs:"' >> status_app.sh
        echo 'if [ -f "emlinh_mng/flask.log" ]; then' >> status_app.sh
        echo '  echo "  ğŸ“‹ Last 5 lines of flask.log:"' >> status_app.sh
        echo '  tail -5 emlinh_mng/flask.log' >> status_app.sh
        echo 'else' >> status_app.sh
        echo '  echo "  âš ï¸ No flask.log found"' >> status_app.sh
        echo 'fi' >> status_app.sh
        echo 'echo ""' >> status_app.sh
        echo '' >> status_app.sh
        echo 'if [ -f "emlinh_mng/error.log" ]; then' >> status_app.sh
        echo '  echo "  ğŸ“‹ Last 5 lines of error.log:"' >> status_app.sh
        echo '  tail -5 emlinh_mng/error.log' >> status_app.sh
        echo 'else' >> status_app.sh
        echo '  echo "  âš ï¸ No error.log found"' >> status_app.sh
        echo 'fi' >> status_app.sh
        echo 'echo ""' >> status_app.sh
        echo '' >> status_app.sh
        echo '# Summary' >> status_app.sh
        echo 'echo "ğŸ“Š === SUMMARY === ğŸ“Š"' >> status_app.sh
        echo 'if [ -f "flask.pid" ] && kill -0 $(cat flask.pid) 2>/dev/null && curl -f -s http://localhost:5000/health >/dev/null 2>&1; then' >> status_app.sh
        echo '  echo "ğŸ‰ Application is HEALTHY and RUNNING!"' >> status_app.sh
        echo '  echo "ğŸ”— Access at: http://localhost:5000"' >> status_app.sh
        echo 'else' >> status_app.sh
        echo '  echo "âš ï¸ Application has issues. Check logs and processes above."' >> status_app.sh
        echo '  echo "ğŸ’¡ Try: ./debug_deployment.sh for detailed diagnostics"' >> status_app.sh
        echo '  echo "ğŸ”„ Try: ./start_app.sh to restart"' >> status_app.sh
        echo 'fi' >> status_app.sh
        
        # Copy debug script
        cp debug_deployment.sh debug_deployment.sh.bak 2>/dev/null || true
        
        chmod +x start_app.sh stop_app.sh status_app.sh debug_deployment.sh
        echo "âœ… Management scripts created:"
        echo "   - start_app.sh: Start the application"
        echo "   - stop_app.sh: Stop the application"  
        echo "   - status_app.sh: Check application status"
        echo "   - debug_deployment.sh: Debug deployment issues"

    - name: Final permission and cleanup setup
      run: |
        echo "ğŸ§¹ Final permission and cleanup setup for host execution..."
        
        # Ensure proper permissions for application directories
        sudo chown -R $USER:$USER . 2>/dev/null || true
        chmod -R 755 . 2>/dev/null || true
        
        # Create log directory
        mkdir -p logs
        chmod 755 logs
        
        # Ensure application directories have correct permissions
        mkdir -p public/audios public/models emlinh_mng/instance 2>/dev/null || true
        mkdir -p emlinh-remotion/out emlinh-remotion/public/audios 2>/dev/null || true
        chmod -R 755 public/ emlinh_mng/instance/ emlinh-remotion/out/ emlinh-remotion/public/audios/ 2>/dev/null || true
        
        echo "âœ… Final setup completed for direct host execution"

  notification:
    runs-on: self-hosted
    needs: [test, deploy]
    if: always()
    
    steps:
    - name: Application status check
      run: |
        echo "ğŸ“Š Final application status check..."
        
        if [ -f "${{ github.workspace }}/flask.pid" ]; then
          if kill -0 $(cat ${{ github.workspace }}/flask.pid) 2>/dev/null; then
            echo "âœ… Flask application is running"
            curl -s http://localhost:5000/health >/dev/null && echo "âœ… Health check passed"
          else
            echo "âš ï¸ Flask application PID file exists but process is not running"
          fi
        else
          echo "âš ï¸ Flask PID file not found"
        fi
        
    - name: Final workspace cleanup
      run: |
        echo "ğŸ§¹ Final workspace cleanup for host execution..."
        
        # Clean up temporary files but keep running applications
        sudo bash -c "
          echo 'Cleaning temporary files...'
          rm -rf '${{ github.workspace }}/public/audios/*' '${{ github.workspace }}/public/models/*' 2>/dev/null || true
          rm -rf '${{ github.workspace }}/emlinh-remotion/out/*' '${{ github.workspace }}/emlinh-remotion/public/audios/*' 2>/dev/null || true
          
          echo 'Ensuring proper permissions...'
          chown -R $USER:$USER '${{ github.workspace }}' 2>/dev/null || echo 'Warning: Some ownership changes failed'
          chmod -R 755 '${{ github.workspace }}' 2>/dev/null || echo 'Warning: Some permission changes failed'
          
          echo 'Recreating directories...'
          mkdir -p '${{ github.workspace }}/public/audios' '${{ github.workspace }}/public/models' '${{ github.workspace }}/emlinh_mng/instance' 2>/dev/null || true
          mkdir -p '${{ github.workspace }}/emlinh-remotion/out' '${{ github.workspace }}/emlinh-remotion/public/audios' 2>/dev/null || true
          chmod -R 755 '${{ github.workspace }}/public/' '${{ github.workspace }}/emlinh_mng/instance/' '${{ github.workspace }}/emlinh-remotion/out/' '${{ github.workspace }}/emlinh-remotion/public/audios/' 2>/dev/null || true
          
          echo 'Cleanup completed successfully'
        " || {
          echo "âš ï¸ Some cleanup operations failed, but continuing..."
        }
        
        echo "âœ… Final cleanup completed for host execution"
        
    - name: Notify deployment status
      run: |
        echo "ğŸ“¢ Deployment Status Notification (Direct Host Execution)"
        echo "=================================================="
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ Deployment thÃ nh cÃ´ng!"
          echo "âœ… á»¨ng dá»¥ng emlinh_mng Ä‘Ã£ Ä‘Æ°á»£c deploy trá»±c tiáº¿p trÃªn host"
          echo "âœ… á»¨ng dá»¥ng emlinh-remotion Ä‘Ã£ Ä‘Æ°á»£c setup trÃªn host"
          echo "ğŸ”— App URL: http://localhost:5000"
          echo "ğŸ“‹ Deployment Mode: Direct Host Execution (No Docker)"
          echo ""
          echo "ğŸ› ï¸  Management Commands:"
          echo "   Start:  ./start_app.sh"
          echo "   Stop:   ./stop_app.sh" 
          echo "   Status: ./status_app.sh"
          echo ""
          echo "ğŸ“ Application Structure:"
          echo "   - Flask App: Running on port 5000 with Gunicorn"
          echo "   - Static Files: Served directly from filesystem"
          echo "   - Logs: Available in emlinh_mng/flask.log"
          echo "   - PID File: flask.pid for process management"
        else
          echo "âŒ Deployment tháº¥t báº¡i!"
          echo "ğŸ” Kiá»ƒm tra logs Ä‘á»ƒ xem chi tiáº¿t lá»—i"
          echo "ğŸ“‹ Mode: Direct Host Execution (No Docker Required)"
          echo ""
          echo "ğŸš¨ Troubleshooting Steps:"
          echo "   1. Run debug script: ./debug_deployment.sh"
          echo "   2. Check application logs: cat emlinh_mng/flask.log"
          echo "   3. Check error logs: cat emlinh_mng/error.log"
          echo "   4. Check application status: ./status_app.sh"
          echo "   5. Try manual restart: ./start_app.sh"
          echo "   6. Test manual startup: cd emlinh_mng && source venv/bin/activate && python src/app/run.py"
          exit 1
        fi
