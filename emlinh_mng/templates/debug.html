<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug SocketIO - Emlinh AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>üîß Debug SocketIO & Video Progress</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üîå SocketIO Connection</h5>
                    </div>
                    <div class="card-body">
                        <div id="connectionStatus" class="alert alert-warning">Ch∆∞a k·∫øt n·ªëi</div>
                        <button class="btn btn-primary" onclick="connectSocket()">K·∫øt n·ªëi SocketIO</button>
                        <button class="btn btn-secondary" onclick="disconnectSocket()">Ng·∫Øt k·∫øt n·ªëi</button>
                        <hr>
                        <div>
                            <label>Session ID:</label>
                            <input type="text" id="sessionId" class="form-control mb-2" placeholder="Nh·∫≠p session ID">
                            <button class="btn btn-success" onclick="joinSession()">Join Session</button>
                            <button class="btn btn-warning" onclick="leaveSession()">Leave Session</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>üé¨ Test Video Creation</h5>
                    </div>
                    <div class="card-body">
                        <div>
                            <label>Topic:</label>
                            <input type="text" id="videoTopic" class="form-control mb-2" value="Debug test video">
                            <button class="btn btn-primary" onclick="createTestVideo()">T·∫°o Video Test</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üì∫ Video Progress Events</h5>
                    </div>
                    <div class="card-body">
                        <div id="progressEvents" style="height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <!-- Events s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                        <button class="btn btn-danger btn-sm mt-2" onclick="clearEvents()">X√≥a Events</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã Console Logs</h5>
                    </div>
                    <div class="card-body">
                        <div id="consoleLogs" style="height: 200px; overflow-y: auto; background: #212529; color: #fff; padding: 10px; border-radius: 5px; font-family: monospace;">
                            <!-- Console logs s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                        <button class="btn btn-danger btn-sm mt-2" onclick="clearLogs()">X√≥a Logs</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentSessionId = null;
        
        // Generate unique session ID
        function generateSessionId() {
            return `debug_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }
        
        // Log function
        function addLog(message, type = 'info') {
            const logs = document.getElementById('consoleLogs');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            logs.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Progress event display
        function addProgressEvent(data) {
            const events = document.getElementById('progressEvents');
            const timestamp = new Date().toLocaleTimeString();
            events.innerHTML += `
                <div class="border-bottom mb-2 pb-2">
                    <strong>[${timestamp}] ${data.step}</strong> (${data.progress}%)<br>
                    <small class="text-muted">Job: ${data.job_id}</small><br>
                    <small>${data.message}</small>
                    ${data.data ? `<br><small class="text-success">Data: ${JSON.stringify(data.data, null, 2)}</small>` : ''}
                </div>
            `;
            events.scrollTop = events.scrollHeight;
        }
        
        // Connect SocketIO
        function connectSocket() {
            try {
                socket = io({
                    transports: ['websocket', 'polling'],
                    upgrade: true,
                    rememberUpgrade: true,
                    timeout: 60000
                });
                
                socket.on('connect', () => {
                    addLog('‚úÖ SocketIO connected - SID: ' + socket.id, 'success');
                    document.getElementById('connectionStatus').innerHTML = 
                        '<div class="alert alert-success">‚úÖ ƒê√£ k·∫øt n·ªëi - SID: ' + socket.id + '</div>';
                    
                    // Auto-generate and set session ID
                    currentSessionId = generateSessionId();
                    document.getElementById('sessionId').value = currentSessionId;
                    addLog('üìã Generated session ID: ' + currentSessionId);
                });
                
                socket.on('disconnect', (reason) => {
                    addLog('üîå SocketIO disconnected: ' + reason, 'error');
                    document.getElementById('connectionStatus').innerHTML = 
                        '<div class="alert alert-warning">‚ö†Ô∏è ƒê√£ ng·∫Øt k·∫øt n·ªëi: ' + reason + '</div>';
                });
                
                socket.on('connect_error', (error) => {
                    addLog('‚ùå Connection error: ' + error, 'error');
                });
                
                // Listen for video progress events
                socket.on('video_progress', (data) => {
                    addLog('üì∫ Received video_progress: ' + JSON.stringify(data), 'success');
                    addProgressEvent(data);
                });
                
                addLog('üîß Attempting to connect SocketIO...');
                
            } catch (error) {
                addLog('‚ùå Failed to create socket: ' + error, 'error');
            }
        }
        
        // Disconnect SocketIO
        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                addLog('üîå Socket disconnected manually');
                document.getElementById('connectionStatus').innerHTML = 
                    '<div class="alert alert-secondary">ƒê√£ ng·∫Øt k·∫øt n·ªëi</div>';
            }
        }
        
        // Join session
        function joinSession() {
            const sessionId = document.getElementById('sessionId').value;
            if (socket && sessionId) {
                socket.emit('join_session', { session_id: sessionId });
                currentSessionId = sessionId;
                addLog('üìã Joining session: ' + sessionId, 'success');
            } else {
                addLog('‚ùå Cannot join session - socket not connected or no session ID', 'error');
            }
        }
        
        // Leave session
        function leaveSession() {
            const sessionId = document.getElementById('sessionId').value;
            if (socket && sessionId) {
                socket.emit('leave_session', { session_id: sessionId });
                addLog('üö™ Leaving session: ' + sessionId);
            }
        }
        
        // Create test video
        function createTestVideo() {
            const topic = document.getElementById('videoTopic').value;
            const sessionId = currentSessionId || document.getElementById('sessionId').value;
            
            if (!sessionId) {
                addLog('‚ùå No session ID set', 'error');
                return;
            }
            
            addLog('üé¨ Creating test video: ' + topic);
            
            const videoData = {
                topic: topic,
                duration: 10,
                composition: 'Scene-Landscape',
                background: 'office',
                voice: 'nova',
                session_id: sessionId
            };
            
            fetch('/api/chat/create-video', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(videoData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('‚úÖ Video creation initiated: ' + data.job_id, 'success');
                } else {
                    addLog('‚ùå Video creation failed: ' + data.message, 'error');
                }
            })
            .catch(error => {
                addLog('‚ùå Request failed: ' + error, 'error');
            });
        }
        
        // Clear functions
        function clearEvents() {
            document.getElementById('progressEvents').innerHTML = '';
        }
        
        function clearLogs() {
            document.getElementById('consoleLogs').innerHTML = '';
        }
        
        // Auto-connect on page load
        window.addEventListener('load', () => {
            addLog('üöÄ Debug page loaded');
            connectSocket();
        });
    </script>
</body>
</html> 